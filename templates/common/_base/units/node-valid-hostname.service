name: node-valid-hostname.service
enabled: true
contents: |
  [Unit]
  Description=Ensure hostname is not localhost
  # Only run when the host has a localhost name.
  ConditionHost=|localhost
  ConditionHost=|localhost.localdomain
  Before=network-online.target

  [Service]
  Type=oneshot
  RemainAfterExit=yes
  ExecStartPre=/bin/echo "Node has localhost hostname. Waiting for new hostname."
  ExecStartPre=/bin/bash -c 'while [[ "$(< /proc/sys/kernel/hostname)" =~ localhost ]]; sleep 1; done;'
  ExecStart=/bin/echo 'Node changed hostname to $(< /proc/sys/kernel/hostname)'
  # Wait up to 5min for the node to get a real hostname.
  KillMode=process
  TimeoutSec=300

  [Install]
  WantedBy=multi-user.target
  # Ensure that network-online.target will not complete until the node has a real hostname.
  RequiredBy=network-online.target
